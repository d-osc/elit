name: Publish @elit/server to NPM

on:
  push:
    tags:
      - 'server-v*' # Trigger on tags like server-v0.1.0, server-v0.2.0-beta

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating GitHub releases
      id-token: write # Required for npm provenance

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install root dependencies
        run: npm ci

      - name: Install server dependencies
        run: cd server && npm ci

      - name: Run type check
        run: cd server && npm run typecheck

      - name: Build package
        run: cd server && npm run build

      - name: Extract version and tag from Git tag
        id: extract_tag
        run: |
          # Get the tag name (e.g., server-v0.1.0, server-v0.1.0-beta)
          GIT_TAG=${GITHUB_REF#refs/tags/}
          echo "git_tag=$GIT_TAG" >> $GITHUB_OUTPUT

          # Remove 'server-v' prefix to get version (e.g., 0.1.0, 0.1.0-beta)
          VERSION=${GIT_TAG#server-v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Determine npm dist-tag based on version
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Stable version (e.g., 0.1.0) -> latest
            NPM_TAG="latest"
          elif [[ "$VERSION" =~ -beta ]]; then
            # Beta version (e.g., 0.1.0-beta, 0.1.0-beta.1) -> beta
            NPM_TAG="beta"
          elif [[ "$VERSION" =~ -alpha ]]; then
            # Alpha version (e.g., 0.1.0-alpha) -> alpha
            NPM_TAG="alpha"
          elif [[ "$VERSION" =~ -next ]]; then
            # Next version (e.g., 0.1.0-next) -> next
            NPM_TAG="next"
          elif [[ "$VERSION" =~ -rc ]]; then
            # Release candidate (e.g., 0.1.0-rc.1) -> rc
            NPM_TAG="rc"
          elif [[ "$VERSION" =~ -([a-zA-Z]+) ]]; then
            # Custom prerelease tag (e.g., 0.1.0-custom) -> custom
            NPM_TAG="${BASH_REMATCH[1]}"
          else
            # Default to latest
            NPM_TAG="latest"
          fi

          echo "npm_tag=$NPM_TAG" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Git Tag: $GIT_TAG"
          echo "ğŸ“Œ Version: $VERSION"
          echo "ğŸ·ï¸  NPM Tag: $NPM_TAG"

      - name: Update package.json version
        run: |
          cd server
          # Update version in package.json
          npm version ${{ steps.extract_tag.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Copy LICENSE to server directory
        run: |
          cp LICENSE server/LICENSE

      - name: Publish @elit/server to NPM
        run: |
          cd server
          npm publish --tag ${{ steps.extract_tag.outputs.npm_tag }} --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_tag.outputs.git_tag }}
          name: "@elit/server v${{ steps.extract_tag.outputs.version }}"
          body: |
            ## @elit/server v${{ steps.extract_tag.outputs.version }}

            Development server with Hot Module Replacement for Elit

            **NPM Package:** [@elit/server](https://www.npmjs.com/package/@elit/server)
            **NPM Tag:** `${{ steps.extract_tag.outputs.npm_tag }}`

            ### Installation
            ```bash
            npm install @elit/server@${{ steps.extract_tag.outputs.npm_tag }}
            ```

            ### Features
            - âš¡ Hot Module Replacement (HMR)
            - ğŸŒ REST API routing with middleware
            - ğŸ”„ Shared state synchronization
            - ğŸ“Š Real-time WebSocket updates
            - ğŸ”’ Security middleware (CORS, rate limiting, etc.)
          draft: false
          prerelease: ${{ steps.extract_tag.outputs.npm_tag != 'latest' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
