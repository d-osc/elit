name: Publish to NPM

on:
  push:
    tags:
      - 'v*' # Trigger on any tag starting with 'v'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating GitHub releases
      id-token: write # Required for npm provenance

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run typecheck

      - name: Build package
        run: npm run build

      - name: Extract version and tag from Git tag
        id: extract_tag
        run: |
          # Get the tag name (e.g., v1.0.0, v1.0.0-beta, v1.0.0-beta.1, v1.0.0-next)
          GIT_TAG=${GITHUB_REF#refs/tags/}
          echo "git_tag=$GIT_TAG" >> $GITHUB_OUTPUT

          # Remove 'v' prefix to get version (e.g., 1.0.0, 1.0.0-beta, 1.0.0-beta.1)
          VERSION=${GIT_TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Determine npm dist-tag based on version
          if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Stable version (e.g., 1.0.0) -> latest
            NPM_TAG="latest"
          elif [[ "$VERSION" =~ -beta ]]; then
            # Beta version (e.g., 1.0.0-beta, 1.0.0-beta.1) -> beta
            NPM_TAG="beta"
          elif [[ "$VERSION" =~ -alpha ]]; then
            # Alpha version (e.g., 1.0.0-alpha, 1.0.0-alpha.1) -> alpha
            NPM_TAG="alpha"
          elif [[ "$VERSION" =~ -next ]]; then
            # Next version (e.g., 1.0.0-next) -> next
            NPM_TAG="next"
          elif [[ "$VERSION" =~ -rc ]]; then
            # Release candidate (e.g., 1.0.0-rc.1) -> rc
            NPM_TAG="rc"
          elif [[ "$VERSION" =~ -([a-zA-Z]+) ]]; then
            # Custom prerelease tag (e.g., 1.0.0-custom) -> custom
            NPM_TAG="${BASH_REMATCH[1]}"
          else
            # Default to latest
            NPM_TAG="latest"
          fi

          echo "npm_tag=$NPM_TAG" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Git Tag: $GIT_TAG"
          echo "ğŸ“Œ Version: $VERSION"
          echo "ğŸ·ï¸  NPM Tag: $NPM_TAG"

      - name: Update package.json version
        run: |
          # Update version in package.json
          npm version ${{ steps.extract_tag.outputs.version }} --no-git-tag-version --allow-same-version

      - name: Publish to NPM
        run: |
          npm publish --tag ${{ steps.extract_tag.outputs.npm_tag }} --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
