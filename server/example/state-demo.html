<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shared State Demo - Elit Server</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #333;
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .card h2 {
      color: #333;
      font-size: 1.25rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      height: 400px;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      background: #f9fafb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .message {
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .message-user {
      font-weight: 600;
      color: #667eea;
    }

    .message-time {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .message-text {
      color: #333;
    }

    .input-group {
      display: flex;
      gap: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    .users-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .user-badge {
      background: #f0f9ff;
      color: #0369a1;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-badge::before {
      content: '‚óè';
      color: #22c55e;
      font-size: 1.5rem;
      line-height: 0;
    }

    .status {
      padding: 12px;
      background: #f0fdf4;
      border-left: 4px solid #22c55e;
      border-radius: 4px;
      font-size: 14px;
      color: #14532d;
      margin-bottom: 15px;
    }

    .status.disconnected {
      background: #fef2f2;
      border-left-color: #ef4444;
      color: #7f1d1d;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }

    .info-box {
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      font-size: 0.875rem;
      color: #78350f;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîÑ Shared State Demo</h1>
      <p class="subtitle">Real-time state synchronization with elit-server</p>
    </div>

    <div id="connectionStatus" class="status">
      Connecting to server...
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="uptimeStat">0s</div>
        <div class="stat-label">Uptime</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="connectionsStat">0</div>
        <div class="stat-label">Connections</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="messagesStat">0</div>
        <div class="stat-label">Messages</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>
          üí¨ Chat Room
          <span class="badge" id="chatBadge">0</span>
        </h2>

        <div class="chat-container">
          <div class="messages" id="messages"></div>

          <div class="input-group">
            <input
              type="text"
              id="usernameInput"
              placeholder="Your name..."
              style="max-width: 150px;"
            >
            <input
              type="text"
              id="messageInput"
              placeholder="Type a message..."
              onkeypress="if(event.key==='Enter') sendMessage()"
            >
            <button onclick="sendMessage()">Send</button>
          </div>
        </div>

        <div class="info-box">
          Open this page in multiple tabs or browsers to see real-time synchronization!
        </div>
      </div>

      <div class="card">
        <h2>
          üë• Online Users
          <span class="badge" id="usersBadge">0</span>
        </h2>

        <div class="users-list" id="usersList">
          <div class="empty-state">No users online</div>
        </div>

        <div class="info-box" style="margin-top: auto;">
          State is synchronized in real-time across all connected clients via WebSocket
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { stateManager } from 'http://localhost:3000/dist/client-state.mjs';

    // Wait for connection
    const ws = stateManager.getWebSocket();

    ws.addEventListener('open', () => {
      updateConnectionStatus(true);
      console.log('‚úÖ Connected to server');
    });

    ws.addEventListener('close', () => {
      updateConnectionStatus(false);
      console.log('‚ùå Disconnected from server');
    });

    // Create shared states
    const chatState = stateManager.create('chat', []);
    const usersState = stateManager.create('online-users', []);
    const statsState = stateManager.create('server-stats', {
      uptime: 0,
      connections: 0,
      messagesCount: 0
    });

    // Subscribe to chat updates
    chatState.onChange((messages) => {
      renderMessages(messages);
      document.getElementById('chatBadge').textContent = messages.length;
    });

    // Subscribe to users updates
    usersState.onChange((users) => {
      renderUsers(users);
      document.getElementById('usersBadge').textContent = users.length;
    });

    // Subscribe to stats updates
    statsState.onChange((stats) => {
      updateStats(stats);
    });

    // Render messages
    function renderMessages(messages) {
      const container = document.getElementById('messages');

      if (messages.length === 0) {
        container.innerHTML = '<div class="empty-state">No messages yet. Start chatting!</div>';
        return;
      }

      container.innerHTML = messages.map(msg => `
        <div class="message">
          <div class="message-header">
            <span class="message-user">${escapeHtml(msg.user)}</span>
            <span class="message-time">${formatTime(msg.timestamp)}</span>
          </div>
          <div class="message-text">${escapeHtml(msg.text)}</div>
        </div>
      `).join('');

      // Auto-scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    // Render users
    function renderUsers(users) {
      const container = document.getElementById('usersList');

      if (users.length === 0) {
        container.innerHTML = '<div class="empty-state">No users online</div>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="user-badge">${escapeHtml(user)}</div>
      `).join('');
    }

    // Update stats
    function updateStats(stats) {
      document.getElementById('uptimeStat').textContent = formatUptime(stats.uptime);
      document.getElementById('connectionsStat').textContent = stats.connections;
      document.getElementById('messagesStat').textContent = stats.messagesCount;
    }

    // Update connection status
    function updateConnectionStatus(connected) {
      const status = document.getElementById('connectionStatus');
      if (connected) {
        status.textContent = '‚úì Connected to server';
        status.className = 'status';
      } else {
        status.textContent = '‚úó Disconnected from server';
        status.className = 'status disconnected';
      }
    }

    // Send message
    window.sendMessage = function() {
      const usernameInput = document.getElementById('usernameInput');
      const messageInput = document.getElementById('messageInput');

      const username = usernameInput.value.trim();
      const text = messageInput.value.trim();

      if (!username) {
        alert('Please enter your name');
        usernameInput.focus();
        return;
      }

      if (!text) {
        messageInput.focus();
        return;
      }

      // Add user to online users if not already there
      const currentUsers = chatState.value || [];
      const uniqueUsers = [...new Set([...usersState.value, username])];
      usersState.value = uniqueUsers;

      // Add message to chat
      const message = {
        id: Date.now(),
        user: username,
        text,
        timestamp: new Date().toISOString()
      };

      chatState.value = [...(chatState.value || []), message];

      messageInput.value = '';
      messageInput.focus();
    };

    // Helper functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString();
    }

    function formatUptime(seconds) {
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
      return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
    }

    console.log('üé® Shared State Demo initialized!');
    console.log('üì° States:', {
      chat: chatState,
      users: usersState,
      stats: statsState
    });
  </script>
</body>
</html>
